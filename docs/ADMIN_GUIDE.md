# PBstats Admin Guide - Multi-Club Management

## Table of Contents

1. [Getting Started](#getting-started)
2. [Club Management](#club-management)
3. [User Management](#user-management)
4. [Data Management](#data-management)
5. [Security & Permissions](#security--permissions)
6. [Troubleshooting](#troubleshooting)
7. [Maintenance Tasks](#maintenance-tasks)

---

## Getting Started

### Admin Roles

**Global Administrator**
- Full access to all clubs and data
- Can create and manage clubs
- Can assign users to clubs and roles
- Access to Firebase Console

**Club Administrator**
- Full access to their specific club's data
- Can manage members within their club
- Cannot access other clubs' data
- Cannot create new clubs

### Accessing the Admin Interface

1. Log in to PBstats with your admin account
2. Navigate to **Clubs** page (visible only to admins)
3. Use the club selector in the navbar to switch between clubs

---

## Club Management

### Creating a New Club

**Prerequisites**: You must be a global administrator

**Steps**:

1. Navigate to the **Clubs** page
2. Click **Create New Club** button
3. Fill in club details:
   - **Name**: Full club name (e.g., "Downtown Pickleball Club")
   - **Description**: Brief description of the club (optional)
4. Click **Create Club**
5. The club is created with `isActive: true` status

**Important Notes**:
- Each club gets a unique ID (generated by Firebase)
- New clubs start with zero members
- You'll need to add yourself and other users as members

### Editing Club Details

**Who can edit**: Global admins and club admins (for their club only)

**Steps**:

1. Navigate to the **Clubs** page
2. Find the club in the list
3. Click the **Edit** button (pencil icon)
4. Update club details:
   - Name
   - Description
5. Click **Save Changes**

**Restrictions**:
- Club ID cannot be changed
- Creation date cannot be changed

### Deleting a Club

**Who can delete**: Global administrators only

**Steps**:

1. Navigate to the **Clubs** page
2. Find the club in the list
3. Click the **Delete** button (trash icon)
4. Confirm deletion in the dialog
5. Club is soft-deleted (`isActive: false`)

**Important**:
- Clubs are soft-deleted, not permanently removed
- Club data remains in the database
- Users can no longer access the club's data
- To restore: manually update `isActive: true` in Firestore Console

### Viewing Club Statistics

Each club card displays:
- **Member Count**: Number of users with access
- **Creation Date**: When the club was created
- **Active Status**: Whether the club is active

---

## User Management

### Adding Users to a Club

**Prerequisites**: User must already have a Firebase account

**Steps**:

1. Open Firebase Console: https://console.firebase.google.com/project/pbstats-claude/firestore
2. Navigate to **Firestore Database** > **users** collection
3. Find the user document by email or ID
4. Click **Edit** on the user document
5. Update the `clubMemberships` array:
   ```json
   {
     "clubMemberships": ["clubId1", "clubId2"]
   }
   ```
6. (Optional) Add club admin role in `clubRoles`:
   ```json
   {
     "clubRoles": {
       "clubId1": "club_admin"
     }
   }
   ```
7. Save changes

**Example**:
```json
{
  "email": "user@example.com",
  "name": "John Doe",
  "role": "player",
  "clubMemberships": ["N2M9BCBuEdE1JKbC93IK"],
  "clubRoles": {
    "N2M9BCBuEdE1JKbC93IK": "club_admin"
  }
}
```

### Removing Users from a Club

**Steps**:

1. Open Firebase Console > Firestore > users collection
2. Find the user document
3. Remove the clubId from `clubMemberships` array
4. Remove the entry from `clubRoles` if exists
5. Save changes

**Effect**: User immediately loses access to that club's data

### User Role Types

**Global Roles** (user.role field):
- `admin`: Global administrator - full system access
- `player`: Regular player - can create/edit data in their clubs
- `viewer`: Read-only access to their clubs

**Club Roles** (user.clubRoles[clubId] field):
- `club_admin`: Administrator for specific club
- Not set / undefined: Regular member

### Finding Club IDs

**Method 1: Clubs Page**
1. Navigate to Clubs page
2. Click on a club card
3. Club ID is in the URL: `/clubs/{clubId}`

**Method 2: Firebase Console**
1. Open Firestore Console
2. Navigate to **clubs** collection
3. Document ID is the club ID

**Method 3: Browser Console**
1. On the Clubs page, open browser DevTools
2. Run: `console.log(clubs)` to see all clubs with IDs

---

## Data Management

### Migrating Existing Data to a Club

If you have data that doesn't have a `clubId`, use migration scripts:

**Available Scripts**:
- `/scripts/assign-players-to-dlwest.ts`
- `/scripts/assign-games-to-dlwest.ts`
- `/scripts/assign-tournaments-to-dlwest.ts`
- `/scripts/assign-circles-to-dlwest.ts`
- `/scripts/assign-box-leagues-to-dlwest.ts`

**Usage**:

1. Edit the script to change `DLWEST_CLUB_ID` to your target club ID:
   ```typescript
   const TARGET_CLUB_ID = 'your-club-id-here';
   ```

2. Run the script:
   ```bash
   npx tsx scripts/assign-players-to-dlwest.ts
   ```

3. Verify migration:
   ```bash
   npx tsx scripts/verify-club-migrations.ts
   ```

### Verifying Data Integrity

Run the verification script to ensure all data has valid clubIds:

```bash
npx tsx scripts/verify-club-migrations.ts
```

**Expected Output**:
```
Collection          Total    With ClubId    Without    Complete
----------------------------------------------------------------------
players                24           24           0      100.0% ✅
games                 191          191           0      100.0% ✅
tournaments            11           11           0      100.0% ✅
circles                 2            2           0      100.0% ✅
boxLeagues              1            1           0      100.0% ✅
```

If any collection shows less than 100%, run the appropriate migration script.

### Moving Data Between Clubs

**Warning**: This operation should be performed with caution

**Steps**:

1. Identify the entity IDs to move (players, games, etc.)
2. Open Firebase Console > Firestore
3. Navigate to the collection (e.g., `players`)
4. For each document to move:
   - Click **Edit**
   - Update the `clubId` field to the new club ID
   - Save changes

**Considerations**:
- Games referencing moved players may have inconsistent data
- Statistics and rankings will be recalculated for new club
- Users from old club will lose access to moved data

### Bulk Data Operations

For bulk operations, create a custom script:

```typescript
#!/usr/bin/env tsx
import { initializeApp } from 'firebase/app';
import { getFirestore, collection, getDocs, doc, updateDoc } from 'firebase/firestore';
import { firebaseConfig } from '../src/lib/firebase-config';

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

async function bulkUpdate() {
  const playersRef = collection(db, 'players');
  const snapshot = await getDocs(playersRef);

  for (const playerDoc of snapshot.docs) {
    // Your update logic here
    await updateDoc(doc(db, 'players', playerDoc.id), {
      // fields to update
    });
  }
}

bulkUpdate();
```

---

## Security & Permissions

### Understanding Security Rules

The app uses Firestore Security Rules for database-level access control.

**Key Rules**:

1. **Club Access**: Users can only access data from clubs they belong to
2. **Immutable clubId**: clubId cannot be changed after entity creation
3. **Authentication Required**: All operations require valid Firebase authentication
4. **Role-Based Access**: Admins have elevated permissions

### Viewing Current Security Rules

**Firebase Console**:
1. Go to https://console.firebase.google.com/project/pbstats-claude/firestore/rules
2. View current deployed rules

**Local File**:
- File: `/firestore.rules`
- Contains all security rule definitions

### Deploying Security Rules

After modifying `/firestore.rules`:

```bash
firebase deploy --only firestore:rules
```

**Important**: Test rules in a development environment before deploying to production.

### Testing Permissions

**As Global Admin**:
1. Log in with admin account
2. Should see all clubs in club selector
3. Can access any club's data
4. Can create new clubs

**As Club Admin**:
1. Log in with club admin account
2. Should see only their clubs in selector
3. Can create/edit/delete data in their clubs
4. Cannot create new clubs

**As Member**:
1. Log in with regular member account
2. Can view and create data in their clubs
3. Can edit their own created data
4. Cannot delete data (unless they created it)

### Common Permission Issues

**Error**: "Missing or insufficient permissions"

**Causes**:
- User not authenticated
- User not in club's clubMemberships
- clubId missing on entity
- Security rule blocking the operation

**Solutions**:
1. Check user authentication status
2. Verify user's clubMemberships in Firebase Console
3. Ensure entity has valid clubId
4. Review firestore.rules for the specific operation

---

## Troubleshooting

### Users Can't See Club Data

**Checklist**:

1. ✓ User is authenticated (check Firebase Auth users list)
2. ✓ Club exists and is active (`isActive: true`)
3. ✓ User's `clubMemberships` includes the club ID
4. ✓ Data entities have the correct `clubId`
5. ✓ Security rules are deployed
6. ✓ User has refreshed the page / cleared cache

**Firebase Console Checks**:
```
1. Firestore > users > {userId}
   - Check clubMemberships array includes clubId

2. Firestore > clubs > {clubId}
   - Verify isActive: true

3. Firestore > players/games/etc
   - Verify documents have clubId field matching the club
```

### Data Appearing in Wrong Club

**Cause**: Incorrect clubId on entity

**Solution**:
1. Open Firebase Console > Firestore
2. Navigate to the entity document
3. Verify `clubId` matches the intended club
4. Update if incorrect

### Club Selector Not Showing Clubs

**Causes**:
- User not logged in
- User's clubMemberships array is empty
- Clubs are inactive

**Solution**:
1. Verify user authentication
2. Check user's clubMemberships in Firebase Console
3. Add user to at least one club
4. Ensure clubs have `isActive: true`

### Cannot Create New Entities

**Cause**: No club selected

**Solution**:
1. Select a club from the club selector in navbar
2. Refresh the page
3. Try creating entity again

**Validation**: All create forms check for selected club before submission.

---

## Maintenance Tasks

### Regular Monitoring

**Weekly Tasks**:

1. **Review User Activity**
   - Check Firebase Console > Authentication for new users
   - Assign new users to appropriate clubs

2. **Check Data Integrity**
   ```bash
   npx tsx scripts/verify-club-migrations.ts
   ```

3. **Monitor Club Growth**
   - Review member counts on Clubs page
   - Track active vs inactive clubs

**Monthly Tasks**:

1. **Backup Database**
   - Firebase Console > Firestore > Backups
   - Schedule automated backups

2. **Review Security Rules**
   - Audit firestore.rules for any needed updates
   - Test with different user roles

3. **Clean Inactive Clubs**
   - Review clubs with `isActive: false`
   - Permanently delete if no longer needed (manual Firestore operation)

### Database Backups

**Automated Backups** (Recommended):

1. Firebase Console > Firestore > Backups
2. Click **Schedule Backup**
3. Set frequency: Daily or Weekly
4. Set retention: 30 days minimum

**Manual Export**:

```bash
gcloud firestore export gs://pbstats-claude-backups/$(date +%Y%m%d)
```

### Checking Firebase Project

To verify which project is active:

```bash
# Check current project
firebase projects:list

# Check project being used
cat .firebaserc

# Verify data exists
npx tsx scripts/check-firebase-project.ts
```

### Updating Firebase Configuration

If you need to switch projects or update config:

1. Update `.firebaserc`:
   ```json
   {
     "projects": {
       "default": "your-project-id"
     }
   }
   ```

2. Update `/src/lib/firebase-config.ts` with new Firebase config

3. Deploy rules to new project:
   ```bash
   firebase deploy --only firestore:rules
   ```

### Performance Optimization

**Create Composite Indexes**:

When you see errors like "The query requires an index", follow the link in the error message to auto-create the index in Firebase Console.

**Common Indexes Needed**:
- Collection: `games`, Fields: `clubId` (Asc), `createdAt` (Desc)
- Collection: `players`, Fields: `clubId` (Asc), `name` (Asc)
- Collection: `tournaments`, Fields: `clubId` (Asc), `startDate` (Desc)

---

## Quick Reference

### Command Cheat Sheet

```bash
# Start development server
npm run dev

# Run migration scripts
npx tsx scripts/verify-club-migrations.ts
npx tsx scripts/assign-players-to-dlwest.ts

# Deploy security rules
firebase deploy --only firestore:rules

# Check Firebase project
firebase projects:list
cat .firebaserc

# TypeScript compilation
npm run typecheck

# Build production
npm run build
```

### Firebase Console URLs

- **Project Dashboard**: https://console.firebase.google.com/project/pbstats-claude
- **Firestore Database**: https://console.firebase.google.com/project/pbstats-claude/firestore
- **Authentication**: https://console.firebase.google.com/project/pbstats-claude/authentication
- **Security Rules**: https://console.firebase.google.com/project/pbstats-claude/firestore/rules
- **Indexes**: https://console.firebase.google.com/project/pbstats-claude/firestore/indexes

### Common Club IDs

- **DLWest**: `N2M9BCBuEdE1JKbC93IK`
- **BAM**: (find in Firestore Console)

### User Role Matrix

| Action | Global Admin | Club Admin | Member | Viewer |
|--------|-------------|------------|--------|--------|
| Create Club | ✅ | ❌ | ❌ | ❌ |
| Edit Club | ✅ | ✅ (own) | ❌ | ❌ |
| Delete Club | ✅ | ❌ | ❌ | ❌ |
| Add Users to Club | ✅ | ✅ (own) | ❌ | ❌ |
| Create Players | ✅ | ✅ | ✅ | ❌ |
| Create Games | ✅ | ✅ | ✅ | ❌ |
| View Data | ✅ (all) | ✅ (own) | ✅ (own) | ✅ (own) |
| Delete Data | ✅ | ✅ (own club) | ❌ | ❌ |

---

## Support & Resources

### Documentation

- **Architecture**: `/docs/CLUB_ARCHITECTURE.md`
- **Security Rules**: `/firestore.rules`
- **Implementation TODO**: `/MULTI_CLUB_TODO.md`

### Getting Help

1. Check this admin guide first
2. Review architecture documentation
3. Check Firebase Console for data issues
4. Review browser console for JavaScript errors
5. Check Firestore rules for permission issues

### Best Practices

1. **Always test in development first** before making production changes
2. **Back up data** before running migration scripts
3. **Use soft deletes** (`isActive: false`) instead of permanent deletion
4. **Document changes** to security rules with comments
5. **Assign minimal permissions** - only give users access they need
6. **Monitor regularly** - check user activity and data integrity weekly
7. **Keep Firebase SDK updated** - check for updates monthly

---

*Last Updated: 2025-12-05*
*PBstats Version: Multi-Club Support (Phase 8 Complete)*
